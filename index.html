<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>ASPECT PROTOCOL</title>
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@500;600&display=swap" rel="stylesheet">
<style>
  .page-frame {
    position: fixed; inset: 0;
    border: 3px solid #FFFFFF;
    box-sizing: border-box;
    pointer-events: none;
    z-index: 9999;
  }

  body {
    font-family: "IBM Plex Sans", "Noto Sans JP", sans-serif;
    background: #000080;
    color: #FFFFFF;
    margin: 0;
    min-height: 100vh;
    display: grid;
    place-items: center;
    transition: filter 0.6s ease;
  }

  body.flash { animation: fireflyGlow 2.2s ease-in-out; }
  @keyframes fireflyGlow {
    0% { filter: brightness(1); }
    40% { filter: brightness(1.15) blur(0.3px); }
    60% { filter: brightness(1.18) blur(0.6px); }
    100% { filter: brightness(1); }
  }

  .container {
    width: min(92vw, 560px);
    display: flex;
    flex-direction: column;
    gap: clamp(24px, 6vw, 60px);
  }

  .preview {
    width: 100%;
    height: clamp(180px, 42vw, 300px);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }

  .frame {
    background: #004687;
    color: #FFFFFF;
    font-weight: 700;
    font-size: clamp(20px, 5vw, 36px);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: clamp(6px, 2vw, 12px) clamp(8px, 3vw, 14px);
    transform-origin: center;
    border: none;
    border-radius: 0;
    transition: width 0.3s ease, height 0.3s ease;
    overflow: hidden;
    box-shadow: 0 0 6px rgba(255,255,255,0.12);
    animation: subtlePulse 8s ease-in-out infinite;
    position: relative;
  }

  @keyframes subtlePulse {
    0%, 100% { box-shadow: 0 0 6px rgba(255,255,255,0.10); }
    50% { box-shadow: 0 0 14px rgba(255,255,255,0.25); }
  }

  .frame.glow::before {
    content: "";
    position: absolute;
    left: 0; top: 0;
    width: 8px; height: 100%;
    background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(0,255,255,0.6));
    box-shadow: 0 0 18px rgba(0,255,255,0.7);
    opacity: .7;
    transition: opacity .3s, box-shadow .3s;
  }
  .frame.glow:hover::before {
    opacity: 1;
    box-shadow: 0 0 28px rgba(0,255,255,1);
  }

  .alias-label {
    position: absolute;
    top: 6px; left: 10px;
    font-size: clamp(12px, 3vw, 15px);
    color: #fff;
    opacity: 0;
    transition: opacity .6s;
    pointer-events: none;
  }
  .alias-label.show { opacity: 1; }

  .mode-label {
    position: absolute;
    right: 8px;
    bottom: 6px;
    font-size: clamp(9px, 2vw, 10px);
    border: 1px solid rgba(255,255,255,0.4);
    border-radius: 4px;
    padding: 2px 5px;
    color: #fff;
    background: rgba(0,0,0,0.2);
    cursor: pointer;
    user-select: none;
  }

  .inline-input {
    width: clamp(62px, 18vw, 110px);
    text-align: center;
    font-size: clamp(18px, 4.2vw, 26px);
    font-weight: 600;
    background: transparent;
    border: none;
    border-bottom: 3px solid rgba(255,255,255,0.8);
    outline: none;
    padding-bottom: 3px;
    line-height: 1;
    appearance: textfield;
    color: #FFFFFF;
  }

  input[type=number]::-webkit-inner-spin-button,
  input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
  input[type=number] { -moz-appearance: textfield; }

  .symbol { font-size: clamp(18px, 4.4vw, 28px); margin: 0 8px; color:#fff; }
  .unit { font-size: clamp(13px, 3.2vw, 18px); margin-left: 4px; color:#fff; }

  .tool-btn {
    width: clamp(34px, 10vw, 44px);
    height: clamp(34px, 10vw, 44px);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border: 1px solid rgba(255,255,255,0.5);
    border-radius: 8px;
    background: rgba(255,255,255,0.12);
    color: #fff;
    font-size: clamp(16px, 5vw, 22px);
    margin-right: 10px;
  }

  .row {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
    gap: 8px;
  }

  .corner-title {
    position: fixed;
    right: 0;
    bottom: 0;
    margin: 0;
    padding: 4px 10px 3px 10px;
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: clamp(9px, 1.5vw, 11px);
    font-weight: 600;
    color: #000060;
    background: #FFD700;
    border-radius: 4px 0 0 0;
    box-shadow: 0 0 8px rgba(255,215,0,0.4);
    letter-spacing: 1.2px;
    text-align: right;
    user-select: none;
    pointer-events: none;
  }
</style>
</head>
<body>
  <div class="page-frame" aria-hidden="true"></div>

  <div class="container">
    <div class="preview" id="preview">
      <div class="frame" id="frame">
        <input type="number" id="ratioW" class="inline-input" value="16" step="any">
        <span class="symbol">：</span>
        <input type="number" id="ratioH" class="inline-input" value="9" step="any">
        <div class="alias-label" id="aliasLabel"></div>
        <div class="mode-label" id="modeLabel">整数モード</div>
      </div>
    </div>

    <div class="row">
      <button class="tool-btn" id="lockBtn">🔗</button>
      <input type="number" id="width" class="inline-input" value="1920">
      <span class="symbol">×</span>
      <input type="number" id="height" class="inline-input" value="1080">
      <span class="unit">px</span>
    </div>
  </div>

  <div class="corner-title">ASPECT PROTOCOL</div>

<script>
const state={ratio:16/9, decimalMode:false, locked:true};
const preview=document.getElementById("preview");
const frame=document.getElementById("frame");
const ratioW=document.getElementById("ratioW");
const ratioH=document.getElementById("ratioH");
const widthInput=document.getElementById("width");
const heightInput=document.getElementById("height");
const modeLabel=document.getElementById("modeLabel");
const lockBtn=document.getElementById("lockBtn");
const aliasLabel=document.getElementById("aliasLabel");

function flashBG(){
  document.body.classList.remove("flash");
  void document.body.offsetHeight;
  document.body.classList.add("flash");
}

function gcd(a,b){a=Math.abs(Math.round(a));b=Math.abs(Math.round(b));return b?gcd(b,a%b):(a||1);}
function safeEval(v){try{const val=Function('"use strict";return('+v+')')();return isFinite(val)?Number(val):0;}catch{return 0;}}
function formatDecimalSmart(r){return(Math.abs(r-Math.round(r))<1e-3)?String(Math.round(r)):r.toFixed(2);}

// 🧩 0入力ガード
function zeroGuardImmediate(e){
  if(!state.decimalMode){
    const v=String(e.target.value).trim();
    if(v==="0") e.target.value="1";
  }
}
ratioW.addEventListener("input", zeroGuardImmediate);
ratioH.addEventListener("input", zeroGuardImmediate);
widthInput.addEventListener("input", zeroGuardImmediate);
heightInput.addEventListener("input", zeroGuardImmediate);

const aliasMap={
  "1024x768":"XGA","1280x800":"WXGA","1600x900":"HD+","1920x1080":"FHD","1920x1200":"WUXGA",
  "2560x1440":"WQHD","2560x1600":"WQXGA","3440x1440":"UWQHD","3840x2160":"UHD 4K","4096x2160":"DCI 4K",
  "5120x2880":"5K","6016x3384":"6K","7680x4320":"UHD 8K","8192x4320":"DCI 8K","1280x720":"HD 720","1366x768":"WXGA"
};
let aliasTimer=null;
function showAlias(){
  const key=`${widthInput.value}x${heightInput.value}`;
  const alias=aliasMap[key];
  if(!alias)return;
  aliasLabel.textContent=alias;
  aliasLabel.classList.add("show");
  clearTimeout(aliasTimer);
  aliasTimer=setTimeout(()=>aliasLabel.classList.remove("show"),5000);
}

function renderFrame(){
  const box=preview.getBoundingClientRect();
  const cW=Math.max(60,box.width-40);
  const cH=Math.max(60,box.height-20);
  const r=Math.max(0.0001,state.ratio);
  let dw,dh;
  if(r>cW/cH){dw=cW;dh=cW/r;}else{dh=cH;dw=cH*r;}
  frame.style.width=`${dw}px`;
  frame.style.height=`${dh}px`;
}

function checkGlow(){
  const rw=safeEval(ratioW.value),rh=safeEval(ratioH.value),g=gcd(rw,rh);
  if(!state.decimalMode&&g>1){frame.classList.add("glow");}
  else{frame.classList.remove("glow");}
}

function updateRatioInputs(){
  if(state.decimalMode){
    const val=formatDecimalSmart(state.ratio);
    ratioW.value=val; ratioH.value=1;
  }else{
    const w=Math.round(state.ratio*100),h=100;
    const g=gcd(w,h);
    ratioW.value=w/g; ratioH.value=h/g;
  }
  checkGlow(); renderFrame();
}

function commitRatioFromInputs(){
  let rw=safeEval(ratioW.value),rh=safeEval(ratioH.value);
  if(rw<=0)rw=1;if(rh<=0)rh=1;
  state.ratio=rw/rh;
  widthInput.value=1920;
  heightInput.value=Math.round(1920/state.ratio);
  renderFrame();flashBG();checkGlow();
}
ratioW.addEventListener("keydown",e=>{if(e.key==="Enter")commitRatioFromInputs();});
ratioH.addEventListener("keydown",e=>{if(e.key==="Enter")commitRatioFromInputs();});

function commitResolutionFromInputs(activeEl){
  let w=safeEval(widthInput.value),h=safeEval(heightInput.value);
  if(w<=0)w=1;if(h<=0)h=1;
  if(state.locked){
    if(activeEl===widthInput){heightInput.value=Math.round(w/state.ratio);}
    else{widthInput.value=Math.round(h*state.ratio);}
  }else{
    state.ratio=w/h; updateRatioInputs();
  }
  renderFrame();flashBG();showAlias();checkGlow();
}

// 🔹 左右どちらの入力もEnterで確定可能に
widthInput.addEventListener("keydown",e=>{if(e.key==="Enter")commitResolutionFromInputs(widthInput);});
heightInput.addEventListener("keydown",e=>{if(e.key==="Enter")commitResolutionFromInputs(heightInput);});
widthInput.addEventListener("change",()=>commitResolutionFromInputs(widthInput));
heightInput.addEventListener("change",()=>commitResolutionFromInputs(heightInput));

frame.addEventListener("click",(e)=>{
  if(e.target.closest(".inline-input")||e.target.closest(".mode-label")) return;
  if(state.decimalMode)return;
  let rw=safeEval(ratioW.value),rh=safeEval(ratioH.value);
  const g=gcd(rw,rh);
  if(g>1){ratioW.value=rw/g;ratioH.value=rh/g;flashBG();checkGlow();}
});

modeLabel.addEventListener("click",()=>{
  state.decimalMode=!state.decimalMode;
  modeLabel.textContent=state.decimalMode?"小数点モード":"整数モード";
  updateRatioInputs();
});

lockBtn.addEventListener("click",()=>{
  state.locked=!state.locked;
  lockBtn.textContent=state.locked?"🔗":"⛓️‍💥";
});

const ro=new ResizeObserver(()=>renderFrame());
ro.observe(preview);
renderFrame();
</script>
</body>
</html>
