<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>Aspect Tool</title>
<style>
:root { --control-h: 44px; }

body{
  font-family:"Inter","Noto Sans JP",sans-serif;
  background:#2e4f4d;
  color:#fff;margin:0;
  min-height:100vh;display:grid;place-items:center;
  transition: background 0.6s ease;
}
.container{width:520px;display:flex;flex-direction:column;gap:28px}

/* 柔らかい背景フラッシュ */
@keyframes bgflash {
  0%   { background-color:#3c6c69; }
  100% { background-color:#2e4f4d; }
}
.flash-bg { animation: bgflash 0.8s ease; }

/* 比率コンテナ */
.preview{
  width:100%;height:220px;display:flex;align-items:center;justify-content:flex-start;
  position:relative;
}
.frame{
  background:#8b7ca8;color:#fff;font-weight:bold;font-size:36px;
  display:flex;justify-content:center;align-items:center;
  border:none;border-radius:0;transition:background 0.3s ease;
  position:relative;padding:10px 14px;
}

/* 入力欄 */
.inline-input{
  width:auto;min-width:56px;max-width:320px;text-align:center;
  font-size:28px;font-weight:600;color:#fff;
  font-family:"Inter","Noto Sans JP",sans-serif;
  background:transparent;border:none;border-bottom:2px solid rgba(255,255,255,.5);
  outline:none;padding:2px 4px;box-sizing:content-box;-moz-appearance:textfield;
}
.inline-input:focus{border-bottom-color:#fff}
.inline-input::-webkit-outer-spin-button,
.inline-input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}

.symbol{font-size:28px;margin:0 6px;color:#fff}
.unit{font-size:18px;margin-left:4px;color:#eee}

/* 🔗/⛓️‍💥ボタン */
.tool-btn{
  width:var(--control-h);height:var(--control-h);
  display:flex;justify-content:center;align-items:center;
  border:1px solid #777;border-radius:8px;
  background:rgba(255,255,255,.12);color:#ddd;font-size:22px;
  cursor:pointer;transition:all .25s;margin-right:12px;
  text-shadow:0 1px 2px rgba(0,0,0,.4);
}
.tool-btn.active{
  background:rgba(255,255,255,.25);
  border-color:#fff;color:#fff;
  box-shadow:0 0 4px rgba(255,255,255,.3);
}

/* 解像度行 */
.row{display:flex;align-items:center;gap:8px;position:relative}

/* 0→1警告 */
.flash{animation:flashline .25s ease}
@keyframes flashline{
  0%{border-bottom-color:#ff6b6b}
  100%{border-bottom-color:rgba(255,255,255,.5)}
}
</style>
</head>
<body>
<div class="container">

  <!-- 比率 -->
  <div class="preview">
    <div class="frame" id="frame">
      <input type="number" id="ratioW" class="inline-input" value="16" step="any">
      <span class="symbol">：</span>
      <input type="number" id="ratioH" class="inline-input" value="9" step="any">
    </div>
  </div>

  <!-- 解像度 -->
  <div class="row">
    <button class="tool-btn active" id="lockBtn" title="縦横を連動">🔗</button>
    <input type="number" id="width"  class="inline-input" placeholder="横幅" value="1920">
    <span class="symbol">×</span>
    <input type="number" id="height" class="inline-input" placeholder="高さ" value="1080">
    <span class="unit">px</span>
  </div>

</div>

<script>
const ratioW=document.getElementById("ratioW");
const ratioH=document.getElementById("ratioH");
const widthInput=document.getElementById("width");
const heightInput=document.getElementById("height");
const frame=document.getElementById("frame");
const lockBtn=document.getElementById("lockBtn");

let ratio=16/9;
let locked=true;

/* オートリサイズ */
function autoResize(input){
  const span=document.createElement("span");
  const cs=getComputedStyle(input);
  span.style.position="fixed";
  span.style.visibility="hidden";
  span.style.whiteSpace="pre";
  span.style.font=`${cs.fontWeight} ${cs.fontSize} ${cs.fontFamily}`;
  document.body.appendChild(span);
  const update=()=>{
    span.textContent=input.value||input.placeholder||"";
    const w=Math.min(Math.max(56,span.offsetWidth+16),320);
    input.style.width=w+"px";
  };
  input.addEventListener("input",update);
  return update;
}
const resizeFns=[ratioW,ratioH,widthInput,heightInput].map(autoResize);
function resizeAll(){resizeFns.forEach(f=>f());}

/* 数式を安全に評価 */
function evalExpression(expr){
  try{
    if(!/^[0-9+\-*/().\s]+$/.test(expr))return NaN;
    return Function(`"use strict";return (${expr})`)();
  }catch{return NaN;}
}

function coerceNonZero(input){
  if(input.value==="")return;
  const v=Number(input.value);
  if(v===0){
    input.value="1";
    input.classList.add("flash");
    setTimeout(()=>input.classList.remove("flash"),260);
  }
}
function gcd(a,b){a=Math.abs(Math.round(a));b=Math.abs(Math.round(b));return b?gcd(b,a%b):(a||1);}
function isNearCine(val){return Math.abs(val-2.35)<0.012;}

/* 背景フラッシュ */
function softFlash(){
  document.body.classList.remove("flash-bg");
  void document.body.offsetWidth;
  document.body.classList.add("flash-bg");
}

/* プレビュー更新 */
function updateFrame(){
  const cW=460,cH=220;
  const r=ratio;
  let dw,dh;
  if(r>cW/cH){dw=cW;dh=cW/r;}else{dh=cH;dw=cH*r;}
  frame.style.width=`${dw}px`;
  frame.style.height=`${dh}px`;

  const rw=parseFloat(ratioW.value);
  const rh=parseFloat(ratioH.value);
  if(!isNearCine(r)&&(String(rw).length>3||String(rh).length>3||rw>99||rh>99)){
    frame.style.background="#aa5555";
  }else{
    frame.style.background="#8b7ca8";
  }
}

/* 比率→解像度 */
function updateResolutionFromRatio(){
  const rw=parseFloat(ratioW.value);
  const rh=parseFloat(ratioH.value);
  if(!rw||!rh)return;
  ratio=rw/rh;
  if(ratio<1){heightInput.value=1920;widthInput.value=Math.round(1920*ratio);}
  else{widthInput.value=1920;heightInput.value=Math.round(1920/ratio);}
  resizeAll();updateFrame();
}

/* 解像度→比率 */
function updateRatioFromResolution(){
  const w=parseFloat(widthInput.value);
  const h=parseFloat(heightInput.value);
  if(!w||!h)return;
  ratio=w/h;
  if(isNearCine(ratio)){ratioW.value=2.35;ratioH.value=1;}
  else{
    const g=gcd(w,h);
    ratioW.value=Math.round(w/g);
    ratioH.value=Math.round(h/g);
  }
  resizeAll();updateFrame();
}

/* Enter確定 */
function onEnterConfirm(input,handler){
  input.addEventListener("keydown",e=>{
    if(e.key==="Enter"){
      e.preventDefault();
      softFlash();

      // 入力式を評価
      const evaluated=evalExpression(input.value);
      if(!isNaN(evaluated)){
        input.value=Math.round(evaluated*1000)/1000;
      }

      // 数値が確定表示されてから再計算
      setTimeout(()=>{
        coerceNonZero(input);
        handler();
      },150); // 150msの遅延で視覚的に“確定→反映”
    }
  });
}
onEnterConfirm(ratioW,updateResolutionFromRatio);
onEnterConfirm(ratioH,updateResolutionFromRatio);

/* 解像度側：Enterで比率更新（ロック考慮） */
onEnterConfirm(widthInput,()=>{
  const w=parseFloat(widthInput.value),h=parseFloat(heightInput.value);
  if(!w||!h)return;
  if(locked){
    heightInput.value=Math.round(w/ratio);
    resizeAll();
    updateFrame();
  }else{
    resizeAll();
    updateRatioFromResolution();
  }
});
onEnterConfirm(heightInput,()=>{
  const w=parseFloat(widthInput.value),h=parseFloat(heightInput.value);
  if(!w||!h)return;
  if(locked){
    widthInput.value=Math.round(h*ratio);
    resizeAll();
    updateFrame();
  }else{
    resizeAll();
    updateRatioFromResolution();
  }
});

/* 🔗/⛓️‍💥切替 */
lockBtn.addEventListener("click",()=>{
  locked=!locked;
  lockBtn.textContent=locked?"🔗":"⛓️‍💥";
  lockBtn.classList.toggle("active",locked);
  if(locked){
    const w=parseFloat(widthInput.value);
    const h=parseFloat(heightInput.value);
    if(w&&h)ratio=w/h;
  }
});

/* 初期化 */
updateResolutionFromRatio();
resizeAll();
updateFrame();
</script>
</body>
</html>

